Console.WriteLine(File.ReadAllLines("input.txt").Select(line => line.Aggregate((0,new List<int>(),true), (curr,c) => curr.Item3 ? (curr.Item1+1, [..curr.Item2, ..Enumerable.Range(0, int.Parse(c + "")).Select(t => curr.Item1)], false) : (curr.Item1, [..curr.Item2, ..Enumerable.Range(0, int.Parse(c+"")).Select(t => -1)], true))).Select(t => System.Collections.Immutable.ImmutableDictionary.ToImmutableDictionary(t.Item2.Select((x, ind) => (x, ind)).ToDictionary(x => x.ind, x => x.x))).Select(dict => Enumerable.Range(0, dict.Where(x => x.Value == -1).Count()).Aggregate((dict, dict.Where(x => x.Value == -1).Min(x => x.Key), dict.Where(x => x.Value != -1).Max(x => x.Key)), (curr, it) => (curr.Item3 > curr.Item2) ? (curr.dict.Remove(curr.Item2).Add(curr.Item2, curr.dict[curr.Item3]).Remove(curr.Item3).Add(curr.Item3, -1), curr.dict.Remove(curr.Item2).Where(x => x.Value == -1).Min(x => x.Key), curr.dict.Remove(curr.Item3).Where(x => x.Value != -1).Max(x => x.Key)) : curr)).Select(dict => dict.dict.Where(x => x.Value != -1).Sum(x => (long)x.Value * x.Key)).First());